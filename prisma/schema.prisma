datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ─── Enums ────────────────────────────────────────────

enum ProjectRole {
  OWNER
  MEMBER
}

enum ToolAccessLevel {
  VIEW
  EDIT
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  TRASHED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum ContentType {
  GUIDE
  STORY
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
}

enum GeoScope {
  STATEWIDE
  OAHU
  MAUI
  KAUAI
  HAWAII_ISLAND
  LANAI
  MOLOKAI
  OTHER
}

enum CollectionLayout {
  TILES
  CARDS
  LIST
}

enum FeedbackVote {
  UP
  DOWN
}

enum FeedbackVoteContext {
  UP
  DOWN
  NONE
}

enum AdminRole {
  ADMIN
  EDITOR
}

// ─── Auth (existing) ──────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  newsletterOptIn          Boolean   @default(false)
  newsletterOptInAt        DateTime?
  newsletterUnsubscribedAt DateTime?
  newsletterUnsubToken     String?   @unique @default(cuid())
  hasSeenNewsletterPrompt  Boolean   @default(false)

  currentProjectId   String?    @map("currentPropertyId")
  currentProject     Project?   @relation("CurrentProject", fields: [currentProjectId], references: [id], onDelete: SetNull)
  projects           Project[]

  toolResults        ToolResult[]
  memberships        ProjectMember[]
  toolAccess         ProjectToolAccess[]
  sentInvites        ProjectInvite[]      @relation("SentInvites")
  shareTokens        ToolShareToken[]     @relation("ShareTokenCreator")
  settingsUpdated    SiteSetting[]
  toolInstanceUpdates ToolInstance[] @relation("ToolInstanceUpdater")
  contentFeedback  ContentFeedback[]
  privateFeedback  ContentPrivateFeedback[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ToolResult {
  id        String    @id @default(cuid())
  userId    String
  toolKey   String
  projectId String?   @map("propertyId")
  payload   Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@unique([userId, toolKey])
  @@index([userId])
  @@index([projectId])
}

model Project {
  id        String        @id @default(cuid())
  userId    String
  name      String        @default("My Home")
  status    ProjectStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentForUsers User[]              @relation("CurrentProject")
  toolResults     ToolResult[]
  toolInstances   ToolInstance[]
  members         ProjectMember[]
  toolAccess      ProjectToolAccess[]
  invites         ProjectInvite[]
  shareTokens     ToolShareToken[]

  @@index([userId])
  @@map("Property")
}

// ─── Project Collaboration ──────────────────────────────

model ToolInstance {
  id          String   @id @default(cuid())
  projectId   String
  toolKey     String
  payload     Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?
  updatedBy   User?    @relation("ToolInstanceUpdater", fields: [updatedById], references: [id], onDelete: SetNull)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, toolKey])
  @@index([projectId])
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@index([projectId])
}

model ProjectToolAccess {
  id        String          @id @default(cuid())
  projectId String
  toolKey   String
  userId    String
  level     ToolAccessLevel @default(VIEW)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, toolKey, userId])
  @@index([projectId, toolKey])
  @@index([userId])
}

model ProjectInvite {
  id        String          @id @default(cuid())
  projectId String
  toolKey   String
  email     String
  level     ToolAccessLevel @default(EDIT)
  token     String          @unique @default(cuid())
  status    InviteStatus    @default(PENDING)
  invitedBy String
  expiresAt DateTime
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter   User            @relation("SentInvites", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([projectId, toolKey])
  @@index([email, status])
  @@index([token])
}

// ─── Public Share Tokens ─────────────────────────────

model ToolShareToken {
  id          String    @id @default(cuid())
  token       String    @unique
  projectId   String
  toolKey     String
  permissions String    @default("READ")
  settings    Json      @default("{}")
  createdBy   String
  revokedAt   DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator     User      @relation("ShareTokenCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([projectId, toolKey])
  @@index([token])
}

// ─── Rate Limiting ────────────────────────────────────

model RateLimit {
  id        String   @id @default(cuid())
  key       String
  ipHash    String
  createdAt DateTime @default(now())

  @@index([key, ipHash, createdAt])
}

// ─── CMS ──────────────────────────────────────────────

model SiteSetting {
  key         String   @id
  value       String
  updatedAt   DateTime @updatedAt
  updatedById String?
  updatedBy   User?    @relation(fields: [updatedById], references: [id], onDelete: SetNull)
}

model Content {
  id                   String        @id @default(cuid())
  contentType          ContentType
  title                String
  slug                 String        @unique
  dek                  String?
  bodyMd               String
  status               ContentStatus @default(DRAFT)
  publishAt            DateTime?
  publishedAt          DateTime?
  authorName           String?
  metaTitle            String?
  metaDescription      String?
  canonicalUrl         String?
  ogImageUrl           String?
  geoScope             GeoScope?
  geoPlace             String?
  robotsNoIndex        Boolean       @default(false)
  primaryCollectionId  String?
  primaryCollection    Collection?   @relation("PrimaryCollection", fields: [primaryCollectionId], references: [id], onDelete: SetNull)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  tags             ContentTag[]
  collectionItems  CollectionItem[]
  images           ContentImage[]
  feedback         ContentFeedback[]
  privateFeedback  ContentPrivateFeedback[]
  relationsFrom    ContentRelation[] @relation("RelationFrom")
  relationsTo      ContentRelation[] @relation("RelationTo")

  @@index([contentType, status])
  @@index([status, publishedAt])
}

model Tag {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String
  isPrimary   Boolean      @default(false)
  contentTags ContentTag[]
}

model ContentTag {
  contentId String
  tagId     String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contentId, tagId])
}

model Collection {
  id            String           @id @default(cuid())
  title         String
  slug          String           @unique
  description   String?
  heroImageUrl  String?
  layout        CollectionLayout @default(TILES)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  items          CollectionItem[]
  primaryContent Content[]        @relation("PrimaryCollection")
}

model CollectionItem {
  id           String     @id @default(cuid())
  collectionId String
  contentId    String
  priority     Int        @default(0)
  pinned       Boolean    @default(false)
  createdAt    DateTime   @default(now())
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  content      Content    @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([collectionId, contentId])
  @@index([collectionId, priority])
}

model ContentRelation {
  id            String   @id @default(cuid())
  fromContentId String
  toContentId   String
  priority      Int      @default(0)
  createdAt     DateTime @default(now())
  fromContent   Content  @relation("RelationFrom", fields: [fromContentId], references: [id], onDelete: Cascade)
  toContent     Content  @relation("RelationTo", fields: [toContentId], references: [id], onDelete: Cascade)

  @@unique([fromContentId, toContentId])
  @@index([fromContentId, priority])
}

model ContentImage {
  id        String   @id @default(cuid())
  contentId String?
  url       String
  alt       String?
  caption   String?
  credit    String?
  sourceUrl String?
  width     Int?
  height    Int?
  createdAt DateTime @default(now())
  content   Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)

  @@index([contentId])
}

model ContentFeedback {
  id        String       @id @default(cuid())
  contentId String
  vote      FeedbackVote
  userId    String?
  anonId    String?
  createdAt DateTime     @default(now())
  content   Content      @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([contentId, userId])
  @@unique([contentId, anonId])
  @@index([contentId])
}

model ContentPrivateFeedback {
  id          String               @id @default(cuid())
  contentId   String
  voteContext  FeedbackVoteContext?
  name        String?
  email       String?
  message     String
  userId      String?
  anonId      String?
  pageUrl     String?
  referrer    String?
  userAgent   String?
  ipHash      String?
  country     String?
  region      String?
  city        String?
  createdAt   DateTime             @default(now())
  content     Content              @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user        User?                @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([contentId, createdAt])
}

model AdminAllowlist {
  id        String    @id @default(cuid())
  email     String    @unique
  role      AdminRole
  createdAt DateTime  @default(now())
}

// ─── Early Access ────────────────────────────────────

enum SignupSource {
  FORM
  GOOGLE
}

model EarlyAccessSignup {
  id        String       @id @default(cuid())
  email     String       @unique
  name      String?
  source    SignupSource  @default(FORM)
  userId    String?
  ipAddress String?
  city      String?
  region    String?
  country   String?
  createdAt DateTime     @default(now())

  @@index([createdAt])
}

model EarlyAccessAllowlist {
  id        String   @id @default(cuid())
  email     String   @unique
  addedBy   String?
  createdAt DateTime @default(now())
}
